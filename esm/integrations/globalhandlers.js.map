{"version":3,"file":"globalhandlers.js","sourceRoot":"","sources":["../../src/integrations/globalhandlers.ts"],"names":[],"mappings":"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","sourcesContent":["import { getCurrentHub } from \"@sentry/core\";\nimport { Integration } from \"@sentry/types\";\nimport { logger } from \"@sentry/utils\";\n\nimport { sdk } from \"../crossPlatform\";\n\n/** JSDoc */\ninterface GlobalHandlersIntegrations {\n  onerror: boolean;\n  onunhandledrejection: boolean;\n  onpagenotfound: boolean;\n  onmemorywarning: boolean;\n}\n\n/** Global handlers */\nexport class GlobalHandlers implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public name: string = GlobalHandlers.id;\n\n  /**\n   * @inheritDoc\n   */\n  public static id: string = \"GlobalHandlers\";\n\n  /** JSDoc */\n  private readonly _options: GlobalHandlersIntegrations;\n\n  /** JSDoc */\n  private _onErrorHandlerInstalled: boolean = false;\n\n  /** JSDoc */\n  private _onUnhandledRejectionHandlerInstalled: boolean = false;\n\n  /** JSDoc */\n  private _onPageNotFoundHandlerInstalled: boolean = false;\n\n  /** JSDoc */\n  private _onMemoryWarningHandlerInstalled: boolean = false;\n\n  /** JSDoc */\n  public constructor(options?: GlobalHandlersIntegrations) {\n    this._options = {\n      onerror: true,\n      onunhandledrejection: true,\n      onpagenotfound: true,\n      onmemorywarning: true,\n      ...options,\n    };\n  }\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(): void {\n    Error.stackTraceLimit = 50;\n\n    if (this._options.onerror) {\n      logger.log(\"Global Handler attached: onError\");\n      this._installGlobalOnErrorHandler();\n    }\n\n    if (this._options.onunhandledrejection) {\n      logger.log(\"Global Handler attached: onunhandledrejection\");\n      this._installGlobalOnUnhandledRejectionHandler();\n    }\n\n    if (this._options.onpagenotfound) {\n      logger.log(\"Global Handler attached: onPageNotFound\");\n      this._installGlobalOnPageNotFoundHandler();\n    }\n\n    if (this._options.onmemorywarning) {\n      logger.log(\"Global Handler attached: onMemoryWarning\");\n      this._installGlobalOnMemoryWarningHandler();\n    }\n  }\n\n  /** JSDoc */\n  private _installGlobalOnErrorHandler(): void {\n    if (this._onErrorHandlerInstalled) {\n      return;\n    }\n\n    if (!!sdk.onError) {\n      const currentHub = getCurrentHub();\n\n      // https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onError.html\n      sdk.onError((err: string | object) => {\n        // console.info(\"sentry-miniapp\", error);\n        const error = typeof err === 'string' ? new Error(err) : err\n        currentHub.captureException(error);\n      });\n    }\n\n    this._onErrorHandlerInstalled = true;\n  }\n\n  /** JSDoc */\n  private _installGlobalOnUnhandledRejectionHandler(): void {\n    if (this._onUnhandledRejectionHandlerInstalled) {\n      return;\n    }\n\n    if (!!sdk.onUnhandledRejection) {\n      const currentHub = getCurrentHub();\n      /** JSDoc */\n      interface OnUnhandledRejectionRes {\n        reason: string | object;\n        promise: Promise<any>;\n      }\n\n      // https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onUnhandledRejection.html\n      sdk.onUnhandledRejection(\n        ({ reason, promise }: OnUnhandledRejectionRes) => {\n          // console.log(reason, typeof reason, promise)\n          // 为什么官方文档上说 reason 是 string 类型，但是实际返回的确实 object 类型\n          const error = typeof reason === 'string' ? new Error(reason) : reason\n          currentHub.captureException(error, {\n            data: promise,\n          });\n        }\n      );\n    }\n\n    this._onUnhandledRejectionHandlerInstalled = true;\n  }\n\n  /** JSDoc */\n  private _installGlobalOnPageNotFoundHandler(): void {\n    if (this._onPageNotFoundHandlerInstalled) {\n      return;\n    }\n\n    if (!!sdk.onPageNotFound) {\n      const currentHub = getCurrentHub();\n\n      sdk.onPageNotFound((res: { path: string }) => {\n        const url = res.path.split(\"?\")[0];\n\n        currentHub.setTag(\"pagenotfound\", url);\n        currentHub.setExtra(\"message\", JSON.stringify(res));\n        currentHub.captureMessage(`页面无法找到: ${url}`);\n      });\n    }\n\n    this._onPageNotFoundHandlerInstalled = true;\n  }\n\n  /** JSDoc */\n  private _installGlobalOnMemoryWarningHandler(): void {\n    if (this._onMemoryWarningHandlerInstalled) {\n      return;\n    }\n\n    if (!!sdk.onMemoryWarning) {\n      const currentHub = getCurrentHub();\n\n      sdk.onMemoryWarning(({ level = -1 }: { level: number }) => {\n        let levelMessage = \"没有获取到告警级别信息\";\n\n        switch (level) {\n          case 5:\n            levelMessage = \"TRIM_MEMORY_RUNNING_MODERATE\";\n            break;\n          case 10:\n            levelMessage = \"TRIM_MEMORY_RUNNING_LOW\";\n            break;\n          case 15:\n            levelMessage = \"TRIM_MEMORY_RUNNING_CRITICAL\";\n            break;\n          default:\n            return;\n        }\n\n        currentHub.setTag(\"memory-warning\", String(level));\n        currentHub.setExtra(\"message\", levelMessage);\n        currentHub.captureMessage(`内存不足告警`);\n      });\n    }\n\n    this._onMemoryWarningHandlerInstalled = true;\n  }\n}\n"]}